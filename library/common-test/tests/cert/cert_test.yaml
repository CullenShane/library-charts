suite: certificate dict test
templates:
  - common.yaml
tests:
  - it: should fail with no ixCertificates key
    set:
      scaleCerts:
        cert_name:
          id: 1
    asserts:
      - failedTemplate:
          errorMessage: Key <ixCertificates> does not exist

  - it: should fail with empty ixCertificates key
    set:
      scaleCerts:
        cert_name:
          id: 1
      # Simulating middleware injection
      ixCertificates: {}
    asserts:
      - failedTemplate:
          errorMessage: Key <ixCertificates> is empty

  - it: should fail with cert that don't exist
    set:
      scaleCerts:
        cert_name:
          id: 1
      # Simulating middleware injection
      ixCertificates:
        "2":
          certificate: cert_content
    asserts:
      - failedTemplate:
          errorMessage: Certificate (1) was not found.

  - it: should fail with expired cert
    set:
      scaleCerts:
        cert_name:
          id: 1
      # Simulating middleware injection
      ixCertificates:
        "1":
          certificate: cert_content
          expired: true
    asserts:
      - failedTemplate:
          errorMessage: Certificate (1) is expired

  - it: should fail with revoked cert
    set:
      scaleCerts:
        cert_name:
          id: 1
      # Simulating middleware injection
      ixCertificates:
        "1":
          certificate: cert_content
          revoked: true
    asserts:
      - failedTemplate:
          errorMessage: Certificate (1) has been revoked

  - it: should pass with 1 secret created
    documentIndex: &secretDoc 0
    set:
      scaleCerts:
        cert_name:
          id: 1
      # Simulating middleware injection
      ixCertificates:
        "1":
          certificate: cert_content
          privatekey: some_key
    asserts:
      - isKind:
          of: Secret
      - isAPIVersion:
          of: v1
      - equal:
          path: type
          value: kubernetes.io/tls
      - equal:
          path: metadata.name
          value: RELEASE-NAME-common-test-cert_name-ixcert-1-0
      - isNotEmpty:
          path: data.tls\.crt
      - isNotEmpty:
          path: data.tls\.key

  - it: should pass with 1 secret created and revision increased
    documentIndex: *secretDoc
    release:
      revision: 1
    set:
      scaleCerts:
        cert_name:
          id: 1
      # Simulating middleware injection
      ixCertificates:
        "1":
          certificate: cert_content
          privatekey: some_key
    asserts:
      - isKind:
          of: Secret
      - isAPIVersion:
          of: v1
      - equal:
          path: type
          value: kubernetes.io/tls
      - equal:
          path: metadata.name
          value: RELEASE-NAME-common-test-cert_name-ixcert-1-1
      - isNotEmpty:
          path: data.tls\.crt
      - isNotEmpty:
          path: data.tls\.key

  - it: should pass with 1 secret created and revision increased and name overriden
    documentIndex: *secretDoc
    release:
      revision: 1
    set:
      scaleCerts:
        cert_name:
          id: 1
          nameOverride: name_override
      # Simulating middleware injection
      ixCertificates:
        "1":
          certificate: cert_content
          privatekey: some_key
    asserts:
      - isKind:
          of: Secret
      - isAPIVersion:
          of: v1
      - equal:
          path: type
          value: kubernetes.io/tls
      - equal:
          path: metadata.name
          value: RELEASE-NAME-common-test-name_override-ixcert-1-1
      - isNotEmpty:
          path: data.tls\.crt
      - isNotEmpty:
          path: data.tls\.key
