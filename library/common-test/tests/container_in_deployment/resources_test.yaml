suite: container in deployment resources test
templates:
  - common.yaml
tests:
  - it: should pass with default values
    documentIndex: &deploymentDoc 0
    asserts:
      - hasDocuments:
          count: 3
      - isKind:
          of: Deployment
      - equal:
          path: spec.template.spec.containers[0].resources
          value:
            limits:
              cpu: 4000m
              memory: 8Gi
            requests:
              cpu: 10m
              memory: 50Mi

  - it: should fail with empty key in gpu
    documentIndex: *deploymentDoc
    set:
      scaleGPU:
        somekey:
      resources:
        limits:
          cpu: 3000m
          memory: 4Gi
        requests:
          cpu: 20m
          memory: 100Mi
    asserts:
      - failedTemplate:
          errorMessage: Value is not provided for GPU (<key> somekey)

  - it: should pass with changed resources
    documentIndex: *deploymentDoc
    set:
      resources:
        limits:
          cpu: 3000m
          memory: 4Gi
        requests:
          cpu: 20m
          memory: 100Mi
    asserts:
      - equal:
          path: spec.template.spec.containers[0].resources
          value:
            limits:
              cpu: 3000m
              memory: 4Gi
            requests:
              cpu: 20m
              memory: 100Mi

  - it: should pass with only limits.cpu resource changed
    documentIndex: *deploymentDoc
    set:
      resources:
        limits:
          cpu: 3000m
    asserts:
      - equal:
          path: spec.template.spec.containers[0].resources
          value:
            limits:
              cpu: 3000m
              memory: 8Gi
            requests:
              cpu: 10m
              memory: 50Mi

  - it: should pass with only limits.memory resource changed
    documentIndex: *deploymentDoc
    set:
      resources:
        limits:
          memory: 4Gi
    asserts:
      - equal:
          path: spec.template.spec.containers[0].resources
          value:
            limits:
              cpu: 4000m
              memory: 4Gi
            requests:
              cpu: 10m
              memory: 50Mi

  - it: should pass with only requests.cpu resource changed
    documentIndex: *deploymentDoc
    set:
      resources:
        requests:
          cpu: 20m
    asserts:
      - equal:
          path: spec.template.spec.containers[0].resources
          value:
            limits:
              cpu: 4000m
              memory: 8Gi
            requests:
              cpu: 20m
              memory: 50Mi

  - it: should pass with only requests.memory resource changed
    documentIndex: *deploymentDoc
    set:
      resources:
        requests:
          memory: 25Mi
    asserts:
      - equal:
          path: spec.template.spec.containers[0].resources
          value:
            limits:
              cpu: 4000m
              memory: 8Gi
            requests:
              cpu: 10m
              memory: 25Mi

  - it: should pass with only scaleGOU resource changed
    documentIndex: *deploymentDoc
    set:
      scaleGPU:
        gpu.intel.com/i915: "1"
    asserts:
      - equal:
          path: spec.template.spec.containers[0].resources
          value:
            limits:
              cpu: 4000m
              memory: 8Gi
              gpu.intel.com/i915: "1"
            requests:
              cpu: 10m
              memory: 50Mi

  - it: should pass with changed resources and added GPU
    documentIndex: *deploymentDoc
    set:
      scaleGPU:
        gpu.intel.com/i915: "1"
      resources:
        limits:
          cpu: 3000m
          memory: 4Gi
        requests:
          cpu: 20m
          memory: 100Mi
    asserts:
      - equal:
          path: spec.template.spec.containers[0].resources
          value:
            limits:
              cpu: 3000m
              memory: 4Gi
              gpu.intel.com/i915: "1"
            requests:
              cpu: 20m
              memory: 100Mi

  - it: should pass with empty resources
    documentIndex: *deploymentDoc
    set:
      scaleGPU: {}
      resources:
        limits:
          cpu:
          memory:
        requests:
          cpu:
          memory:
    asserts:
      - isNull:
          path: spec.template.spec.containers[0].resources

  - it: should pass with only limits.cpu defined
    documentIndex: *deploymentDoc
    set:
      scaleGPU: {}
      resources:
        limits:
          cpu: 3000m
          memory:
        requests:
          cpu:
          memory:
    asserts:
      - equal:
          path: spec.template.spec.containers[0].resources
          value:
            limits:
              cpu: 3000m

  - it: should pass with only limits.memory defined
    documentIndex: *deploymentDoc
    set:
      scaleGPU: {}
      resources:
        limits:
          cpu:
          memory: 4Gi
        requests:
          cpu:
          memory:
    asserts:
      - equal:
          path: spec.template.spec.containers[0].resources
          value:
            limits:
              memory: 4Gi

  - it: should pass with only requests.cpu defined
    documentIndex: *deploymentDoc
    set:
      scaleGPU: {}
      resources:
        limits:
          cpu:
          memory:
        requests:
          cpu: 10m
          memory:
    asserts:
      - equal:
          path: spec.template.spec.containers[0].resources
          value:
            requests:
              cpu: 10m

  - it: should pass with only requests.memory defined
    documentIndex: *deploymentDoc
    set:
      scaleGPU: {}
      resources:
        limits:
          cpu:
          memory:
        requests:
          cpu:
          memory: 50Mi
    asserts:
      - equal:
          path: spec.template.spec.containers[0].resources
          value:
            requests:
              memory: 50Mi

  - it: should pass with only limits.gpu defined
    documentIndex: *deploymentDoc
    set:
      scaleGPU:
        gpu.intel.com/i915: "1"
      resources:
        limits:
          cpu:
          memory:
        requests:
          cpu:
          memory:
    asserts:
      - equal:
          path: spec.template.spec.containers[0].resources
          value:
            limits:
              gpu.intel.com/i915: "1"

  - it: should pass with only requests defined
    documentIndex: *deploymentDoc
    set:
      scaleGPU: {}
      resources:
        limits:
          cpu:
          memory:
        requests:
          cpu: 10m
          memory: 50Mi
    asserts:
      - equal:
          path: spec.template.spec.containers[0].resources
          value:
            requests:
              cpu: 10m
              memory: 50Mi

  - it: should pass with only limits defined
    documentIndex: *deploymentDoc
    set:
      scaleGPU: {}
      resources:
        limits:
          cpu: 3000m
          memory: 4Gi
        requests:
          cpu:
          memory:
    asserts:
      - equal:
          path: spec.template.spec.containers[0].resources
          value:
            limits:
              cpu: 3000m
              memory: 4Gi

  - it: should pass with only gpu defined
    documentIndex: *deploymentDoc
    set:
      scaleGPU:
        gpu.intel.com/i915: "1"
      resources:
        limits:
          cpu:
          memory:
        requests:
          cpu:
          memory:
    asserts:
      - equal:
          path: spec.template.spec.containers[0].resources
          value:
            limits:
              gpu.intel.com/i915: "1"
