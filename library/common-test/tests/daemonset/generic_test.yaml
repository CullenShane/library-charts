suite: daemonset generic test
templates:
  - common.yaml
tests:
  - it: should pass with controller set to DaemonSet
    documentIndex: &daemonsetDoc 0
    set:
      controller.type: DaemonSet
    asserts:
      - hasDocuments:
          count: 3
      - isKind:
          of: DaemonSet
      - isAPIVersion:
          of: apps/v1


  - it: should pass with podSecurityContext changed
    documentIndex: *daemonsetDoc
    set:
      controller.type: DaemonSet
      podSecurityContext:
        fsGroup: 0
        fsGroupChangePolicy: Always
        supplementalGroups:
          - 1000
    asserts:
      - equal:
          path: spec.template.spec.securityContext
          value:
            fsGroup: 0
            fsGroupChangePolicy: Always
            supplementalGroups:
              - 1000

  - it: should pass with podSecurityContext changed
    documentIndex: *daemonsetDoc
    set:
      controller.type: DaemonSet
      securityContext:
        runAsUser: 1000
        runAsGroup: 1000
        capabilities:
          add:
            - something
    asserts:
      - equal:
          path: spec.template.spec.containers[0].securityContext
          value:
            allowPrivilegeEscalation: false
            privileged: false
            readOnlyRootFilesystem: true
            runAsNonRoot: true
            runAsUser: 1000
            runAsGroup: 1000
            capabilities:
              add:
                - something
              drop:
                - ALL

  - it: should pass with multiple envs defined via tpl
    documentIndex: *daemonsetDoc
    set:
      controller.type: DaemonSet
      some_string: a_string
      some_int: 123
      some_bool: false
      env:
        ENVVAR: "{{ .Values.some_string }}"
        ENVVAR2: "{{ .Values.some_int }}"
        ENVVAR3: "{{ .Values.some_bool }}"
    asserts:
      - equal:
          path: spec.template.spec.containers[0].env
          value:
            - name: TZ
              value: "UTC"
            - name: UMASK
              value: "002"
            - name: UMASK_SET
              value: "002"
            - name: NVIDIA_VISIBLE_DEVICES
              value: "void"
            - name: S6_READ_ONLY_ROOT
              value: "1"
            - name: ENVVAR
              value: "a_string"
            - name: ENVVAR2
              value: "123"
            - name: ENVVAR3
              value: "false"

  - it: should pass with image defined in init containers
    documentIndex: *daemonsetDoc
    set:
      controller.type: DaemonSet
      image:
        repository: some-repo
        tag: some-tag
        pullPolicy: Always
      someImage:
        repository: some-other-repo
        tag: some-other-tag
        pullPolicy: Never
      additionalContainers:
        some-name:
          imageSelector: someImage
          pullPolicy: Never
      initContainers:
        some-name:
          imageSelector: someImage
          pullPolicy: Never
      systemContainers:
        some-name:
          imageSelector: someImage
          pullPolicy: Never
      installContainers:
        some-name:
          imageSelector: someImage
          pullPolicy: Never
    asserts:
      - isSubset:
          path: spec.template.spec.containers[0]
          content:
            image: some-repo:some-tag
            imagePullPolicy: Always
      - lengthEqual:
          path: spec.template.spec.containers
          count: 2
      - lengthEqual:
          path: spec.template.spec.initContainers
          count: 3
