suite: cronJobs test
templates:
  - common.yaml
tests:
  - it: should pass with default values
    documentIndex: &deploymentDoc 0
    asserts:
      - hasDocuments:
          count: 3
      - isKind:
          of: Deployment

  - it: should fail without schedule in cronjobs
    set:
      jobs:
        job-name:
          enabled: true
          cron:
            enabled: true
    asserts:
      - failedTemplate:
          errorMessage: <cron.schedule> is required in <job> (job-name)

  - it: should fail with non-string schedule in cronjobs
    set:
      jobs:
        job-name:
          enabled: true
          cron:
            enabled: true
            schedule: 1
    asserts:
      - failedTemplate:
          errorMessage: <cron.schedule> must be a string in <job> (job-name)

  - it: should fail with non-string timezone in cronjobs
    set:
      jobs:
        job-name:
          enabled: true
          cron:
            enabled: true
            schedule: "* * * * *"
            timezone: 2
    asserts:
      - failedTemplate:
          errorMessage: <cron.timezone> must be a string in <job> (job-name). Leave empty to use the default (UTC)

  - it: should fail with invalid concurrencyPolicy in cronjobs
    set:
      jobs:
        job-name:
          enabled: true
          cron:
            enabled: true
            schedule: "* * * * *"
            concurrencyPolicy: invalid
    asserts:
      - failedTemplate:
          errorMessage: Invalid option (invalid) for <cron.concurrencyPolicy> in <job> (job-name). Valid options are Allow, Forbid, Replace. Leave empty to use the default (Forbid)

  - it: should fail with negative value in failedJobsHistoryLimit in cronjobs
    set:
      jobs:
        job-name:
          enabled: true
          cron:
            enabled: true
            schedule: "* * * * *"
            failedJobsHistoryLimit: -1
    asserts:
      - failedTemplate:
          errorMessage: <cron.failedJobsHistoryLimit> (-1) in <job> (job-name) must be a positive integer. Leave empty to use (1)

  - it: should fail with negative value in successfulJobsHistoryLimit in cronjobs
    set:
      jobs:
        job-name:
          enabled: true
          cron:
            enabled: true
            schedule: "* * * * *"
            successfulJobsHistoryLimit: -1
    asserts:
      - failedTemplate:
          errorMessage: <cron.successfulJobsHistoryLimit> (-1) in <job> (job-name) must be a positive integer. Leave empty to use (3)

  - it: should fail with zero value in startingDeadlineSeconds in cronjobs
    set:
      jobs:
        job-name:
          enabled: true
          cron:
            enabled: true
            schedule: "* * * * *"
            startingDeadlineSeconds: 0
    asserts:
      - failedTemplate:
          errorMessage: Zero value in <cron.startingDeadlineSeconds> (0) in <job> (job-name) is not allowed.

  - it: should fail with negative value in startingDeadlineSeconds in cronjobs
    set:
      jobs:
        job-name:
          enabled: true
          cron:
            enabled: true
            schedule: "* * * * *"
            startingDeadlineSeconds: -1
    asserts:
      - failedTemplate:
          errorMessage: <cron.startingDeadlineSeconds> (-1) in <job> (job-name) must be a positive integer.
