suite: jobTemplate test
templates:
  - common.yaml
tests:
  - it: should pass with default values
    documentIndex: &deploymentDoc 0
    asserts:
      - hasDocuments:
          count: 3
      - isKind:
          of: Deployment

  - it: should pass with default in job
    documentIndex: &jobDoc 3
    set:
      jobs:
        job-name:
          enabled: true
          podSpec:
            containers:
              main:
                imageSelector: image
    asserts:
      - isKind:
          of: Job
      - isAPIVersion:
          of: batch/v1

  - it: should pass with default container
    documentIndex: *jobDoc
    set:
      jobs:
        job-name:
          enabled: true
          podSpec:
            containers:
              main:
                imageSelector: image
    asserts:
      - equal:
          path: spec.template.spec.containers[0]
          value:
            name: RELEASE-NAME-common-test-job-main
            image: repo:tag
            imagePullPolicy: IfNotPresent
            tty: false
            stdin: false
            env:
              - name: "TZ"
                value: "UTC"
              - name: "UMASK"
                value: "002"
              - name: "UMASK_SET"
                value: "002"
              - name: "NVIDIA_VISIBLE_DEVICES"
                value: "void"
              - name: "S6_READ_ONLY_ROOT"
                value: "1"
            securityContext:
              runAsNonRoot: true
              runAsUser: 568
              runAsGroup: 568
              readOnlyRootFilesystem: true
              allowPrivilegeEscalation: false
              privileged: false
              capabilities:
                add: []
                drop:
                  - "ALL"
            resources:
              requests:
                cpu: 10m
                memory: 50Mi
              limits:
                cpu: 4000m
                memory: 8Gi

  - it: should pass with image defined in job container
    documentIndex: *jobDoc
    set:
      jobImage:
        repository: some-repo-job
        tag: some-tag-job
        pullPolicy: Never
      jobs:
        job-name:
          enabled: true
          podSpec:
            containers:
              main:
                imageSelector: jobImage
    asserts:
      - isSubset:
          path: spec.template.spec.containers[0]
          content:
            image: some-repo-job:some-tag-job
            imagePullPolicy: Never

  - it: should pass with tty and stdin defined in job container
    documentIndex: *jobDoc
    set:
      jobs:
        job-name:
          enabled: true
          podSpec:
            containers:
              main:
                imageSelector: image
                tty: true
                stdin: true
    asserts:
      - isSubset:
          path: spec.template.spec.containers[0]
          content:
            tty: true
            stdin: true

  - it: should pass with command defined in job container
    documentIndex: *jobDoc
    set:
      port: 8080
      entrypoint: ./run.sh
      jobs:
        job-name:
          enabled: true
          podSpec:
            containers:
              main:
                imageSelector: image
                command:
                  - /bin/sh
                  - -c
                  - |
                    {{ .Values.entrypoint }}
                args:
                  - --port
                  - "{{ .Values.port }}"
                extraArgs:
                  - --data_dir
                  - /data
    asserts:
      - isSubset:
          path: spec.template.spec.containers[0]
          content:
            command:
              - /bin/sh
              - -c
              - |
                ./run.sh
            args:
              - --port
              - "8080"
              - --data_dir
              - /data

  - it: should pass with termination defined in job container
    documentIndex: *jobDoc
    set:
      port: 8080
      entrypoint: ./run.sh
      jobs:
        job-name:
          enabled: true
          podSpec:
            containers:
              main:
                imageSelector: image
                termination:
                  messagePath: somePath
                  messagePolicy: File
    asserts:
      - isSubset:
          path: spec.template.spec.containers[0]
          content:
            terminationMessagePath: somePath
            terminationMessagePolicy: File

  - it: should pass with resources inherited from main container and modified in job container
    documentIndex: *jobDoc
    set:
      resources:
        requests:
          cpu: 25m
          memory: 80Mi
      jobs:
        some-name:
          enabled: true
          podSpec:
            containers:
              main:
                resources:
                  inherit: true
                  limits:
                    cpu: 1000m
                    memory: 1Gi
                  requests:
                    memory: 120Mi
    asserts:
      - isSubset:
          path: spec.template.spec.containers[0]
          content:
            resources:
              limits:
                cpu: 1000m
                memory: 1Gi
              requests:
                cpu: 25m
                memory: 120Mi

  - it: should pass with resources defined in job container
    documentIndex: *jobDoc
    set:
      jobs:
        some-name:
          enabled: true
          podSpec:
            containers:
              main:
                nvidiaCaps:
                  - compute
                scaleGPU:
                  gpu.intel.com/i915: "1"
                resources:
                  limits:
                    cpu: 3000m
                    memory: 4Gi
                  requests:
                    cpu: 20m
                    memory: 100Mi
    asserts:
      - isSubset:
          path: spec.template.spec.containers[0]
          content:
            resources:
              limits:
                cpu: 3000m
                memory: 4Gi
                gpu.intel.com/i915: "1"
              requests:
                cpu: 20m
                memory: 100Mi
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: NVIDIA_DRIVER_CAPABILITIES
            value: compute

  - it: should pass with envFrom defined in job container
    documentIndex: *jobDoc
    set:
      some_name: a_name
      some_name2: a_name2
      jobs:
        some-name:
          enabled: true
          podSpec:
            containers:
              main:
                envFrom:
                  - configMapRef:
                      name: "{{ .Values.some_name }}"
                  - configMapRef:
                      name: "{{ .Values.some_name2 }}"
    asserts:
      - isSubset:
          path: spec.template.spec.containers[0]
          content:
            envFrom:
              - configMapRef:
                  name: a_name
              - configMapRef:
                  name: a_name2

  - it: should pass with env and envList defined in init container
    documentIndex: *jobDoc
    set:
      some_value: value
      some_value2: value2
      some_value3: value3
      some_value4: value4
      jobs:
        some-name:
          enabled: true
          podSpec:
            containers:
              main:
                env:
                  var1: "{{ .Values.some_value }}"
                  var2: "{{ .Values.some_value2 }}"
                envList:
                  - name: var3
                    value: "{{ .Values.some_value3 }}"
                  - name: var4
                    value: "{{ .Values.some_value4 }}"
    asserts:
      - isSubset:
          path: spec.template.spec.containers[0]
          content:
            env:
              - name: TZ
                value: UTC
              - name: UMASK
                value: "002"
              - name: UMASK_SET
                value: "002"
              - name: NVIDIA_VISIBLE_DEVICES
                value: void
              - name: S6_READ_ONLY_ROOT
                value: "1"
              - name: var1
                value: value
              - name: var2
                value: value2
              - name: var3
                value: value3
              - name: var4
                value: value4
