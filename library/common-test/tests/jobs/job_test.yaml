suite: jobTemplate test
templates:
  - common.yaml
tests:
  - it: should pass with default values
    documentIndex: &deploymentDoc 0
    asserts:
      - hasDocuments:
          count: 3
      - isKind:
          of: Deployment

  - it: should pass with disabled job
    set:
      jobs:
        job-name:
          enabled: false
          containers:
            some-container:
    asserts:
      - hasDocuments:
          count: 3

  - it: should pass with defined job
    documentIndex: &jobDoc 3
    set:
      jobs:
        job-name:
          enabled: true
          containers:
            some-container:
    asserts:
      - isKind:
          of: Job
      - isAPIVersion:
          of: batch/v1
      - isNull:
          path: metadata.annotations
      - equal:
          path: metadata.name
          value: RELEASE-NAME-common-test-job-name

  - it: should pass with nameOverride defined in job
    documentIndex: *jobDoc
    set:
      jobs:
        job-name:
          enabled: true
          nameOverride: other-job-name
          containers:
            some-container:
    asserts:
      - equal:
          path: metadata.name
          value: RELEASE-NAME-common-test-other-job-name

  - it: should pass with global labels and labels from tpl defined in job
    documentIndex: *jobDoc
    set:
      l1: val1
      l2: val2
      global:
        labels:
          label1: val3
          label2: val4
      jobs:
        job-name:
          enabled: true
          labels:
            l1: "{{ .Values.l1 }}"
            l2: "{{ .Values.l2 }}"
          containers:
            some-container:
    asserts:
      - equal:
          path: metadata.labels
          value:
            app: common-test
            release: RELEASE-NAME
            app.kubernetes.io/instance: RELEASE-NAME
            app.kubernetes.io/managed-by: Helm
            app.kubernetes.io/name: common-test
            app.kubernetes.io/version: v1.0.0
            helm-revision: "0"
            helm.sh/chart: common-test-1.0.0
            l1: val1
            l2: val2
            label1: val3
            label2: val4

  - it: should pass with annotations from tpl defined in job
    documentIndex: *jobDoc
    set:
      a1: val1
      a2: val2
      global:
        annotations:
          annotation1: val3
          annotation2: val4
      jobs:
        job-name:
          enabled: true
          annotations:
            a1: "{{ .Values.a1 }}"
            a2: "{{ .Values.a2 }}"
          containers:
            some-container:
    asserts:
      - equal:
          path: metadata.annotations
          value:
            a1: val1
            a2: val2
            annotation1: val3
            annotation2: val4
