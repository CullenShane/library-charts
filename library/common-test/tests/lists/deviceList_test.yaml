suite: deviceList test
templates:
  - common.yaml
tests:
  - it: should pass with default values
    documentIndex: &deploymentDoc 0
    asserts:
      - hasDocuments:
          count: 3
      - isKind:
          of: Deployment
      - isNull:
          path: spec.template.spec.volume
      - isNull:
          path: spec.template.spec.containers[0].volumeMounts

  - it: should pass with deviceList defined
    documentIndex: *deploymentDoc
    set:
      deviceList:
        - enabled: true
          type: hostPath
          mountPath: /dev/usb
          hostPath: /dev/usb
    asserts:
      - isSubset:
          path: spec.template.spec.containers[0]
          content:
            volumeMounts:
              - name: device-0
                mountPath: /dev/usb
      - isSubset:
          path: spec.template.spec
          content:
            volumes:
              - name: device-0
                hostPath:
                  path: /dev/usb

  - it: should pass with deviceList defined as readOnly
    documentIndex: *deploymentDoc
    set:
      deviceList:
        - enabled: true
          type: hostPath
          mountPath: /dev/usb
          hostPath: /dev/usb
          readOnly: true
    asserts:
      - isSubset:
          path: spec.template.spec.containers[0]
          content:
            volumeMounts:
              - name: device-0
                mountPath: /dev/usb
                readOnly: true
      - isSubset:
          path: spec.template.spec
          content:
            volumes:
              - name: device-0
                hostPath:
                  path: /dev/usb

  - it: should pass with deviceList defined, validateHostPath true and a malicious not allowed path
    documentIndex: *deploymentDoc
    set:
      deviceList:
        - enabled: true
          type: hostPath
          mountPath: /dev/usb
          hostPath: /mnt
          validateHostPath: true
    asserts:
      - failedTemplate:
          errorMessage: Invalid hostPath (/mnt). Allowed hostPaths are valid paths under a given pool. e.g. /mnt/POOL/DATASET, /mnt/POOL/DATASET/DIRECTORY
