suite: deployment annotation test
templates:
  - common.yaml
tests:
  - it: should pass with default values
    asserts:
      - documentIndex: &deploymentDoc 0
        isKind:
          of: Deployment
      - isNotEmpty:
          documentIndex: *deploymentDoc
          path: metadata.annotations.rollme

  - it: should pass with controller and global annotations
    set:
      some_key: some_value
      controller.annotations:
        controller_key: controller_value
        controller_key2: "{{ .Values.some_key }}"
      global.annotations:
        global_key: global_value
        global_key2: "{{ .Values.some_key }}"
    asserts:
      - equal:
          documentIndex: *deploymentDoc
          path: metadata.annotations.controller_key
          value: controller_value
      - equal:
          documentIndex: *deploymentDoc
          path: metadata.annotations.controller_key2
          value: some_value
      - equal:
          documentIndex: *deploymentDoc
          path: metadata.annotations.global_key
          value: global_value
      - equal:
          documentIndex: *deploymentDoc
          path: metadata.annotations.global_key2
          value: some_value
      - isNotEmpty:
          documentIndex: *deploymentDoc
          path: metadata.annotations.rollme

  - it: should pass with podAnnotations set
    set:
      some_key: some_value2
      podAnnotations.test: some_value
      podAnnotations.test2: "{{ .Values.some_key }}"
    asserts:
      - equal:
          documentIndex: *deploymentDoc
          path: spec.template.metadata.annotations.test2
          value: some_value2
      - equal:
          documentIndex: *deploymentDoc
          path: spec.template.metadata.annotations.test
          value: some_value
