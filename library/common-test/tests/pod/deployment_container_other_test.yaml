
suite: deployment container various options test
templates:
  - common.yaml
tests:
  - it: should pass with default values
    asserts:
      - documentIndex: &deploymentDoc 0
        isKind:
          of: Deployment

  - it: should pass with tty set
    set:
      tty: true
    asserts:
      - equal:
          documentIndex: *deploymentDoc
          path: spec.template.spec.containers[0].tty
          value: true

  - it: should pass with stdin set
    set:
      stdin: true
    asserts:
      - equal:
          documentIndex: *deploymentDoc
          path: spec.template.spec.containers[0].stdin
          value: true

  - it: should pass with hostNetwork set
    set:
      hostNetwork: true
    asserts:
      - equal:
          documentIndex: *deploymentDoc
          path: spec.template.spec.hostNetwork
          value: true

  - it: should pass with hostname set
    set:
      hostname: some_hostname
    asserts:
      - equal:
          documentIndex: *deploymentDoc
          path: spec.template.spec.hostname
          value: some_hostname

  - it: should pass with hostname set from tpl
    set:
      name: some_hostname
      hostname: "{{ .Values.name }}"
    asserts:
      - equal:
          documentIndex: *deploymentDoc
          path: spec.template.spec.hostname
          value: some_hostname

  - it: should pass with gracePeriodSeconds set
    set:
      termination:
        gracePeriodSeconds: 25
    asserts:
      - equal:
          documentIndex: *deploymentDoc
          path: spec.template.spec.terminationGracePeriodSeconds
          value: 25

  - it: should pass with enableServiceLinks set
    set:
      enableServiceLinks: true
    asserts:
      - equal:
          documentIndex: *deploymentDoc
          path: spec.template.spec.enableServiceLinks
          value: true

  - it: should pass with schedulerName set
    set:
      schedulerName: some_scheduler
    asserts:
      - equal:
          documentIndex: *deploymentDoc
          path: spec.template.spec.schedulerName
          value: some_scheduler

  - it: should pass with schedulerName set from tpl
    set:
      name: some_scheduler
      schedulerName: "{{ .Values.name }}"
    asserts:
      - equal:
          documentIndex: *deploymentDoc
          path: spec.template.spec.schedulerName
          value: some_scheduler

  - it: should pass with schedulerName set
    set:
      priorityClassName: some_priority_class_name
    asserts:
      - equal:
          documentIndex: *deploymentDoc
          path: spec.template.spec.priorityClassName
          value: some_priority_class_name

  - it: should pass with schedulerName set from tpl
    set:
      name: some_priority_class_name
      priorityClassName: "{{ .Values.name }}"
    asserts:
      - equal:
          documentIndex: *deploymentDoc
          path: spec.template.spec.priorityClassName
          value: some_priority_class_name

  - it: should pass with single postStart lifecycle set
    set:
      lifecycle:
        postStart:
          command: some_command
    asserts:
      - equal:
          documentIndex: *deploymentDoc
          path: spec.template.spec.containers[0].lifecycle
          value:
            postStart:
              exec:
                command:
                  - some_command

  - it: should pass with single postStart lifecycle set from tpl
    set:
      some_key: some_command
      lifecycle:
        postStart:
          command: "{{ .Values.some_key }}"
    asserts:
      - equal:
          documentIndex: *deploymentDoc
          path: spec.template.spec.containers[0].lifecycle
          value:
            postStart:
              exec:
                command:
                  - some_command

  - it: should pass with postStart lifecycle set
    set:
      lifecycle:
        postStart:
          command:
            - /bin/bash
            - test
    asserts:
      - equal:
          documentIndex: *deploymentDoc
          path: spec.template.spec.containers[0].lifecycle
          value:
            postStart:
              exec:
                command:
                  - /bin/bash
                  - test

  - it: should pass with postStart lifecycle set from tpl
    set:
      some_key: some_value
      lifecycle:
        postStart:
          command:
            - /bin/bash
            - "{{ .Values.some_key }}"
    asserts:
      - equal:
          documentIndex: *deploymentDoc
          path: spec.template.spec.containers[0].lifecycle
          value:
            postStart:
              exec:
                command:
                  - /bin/bash
                  - some_value

  - it: should pass with single preStop lifecycle set
    set:
      lifecycle:
        preStop:
          command: some_command
    asserts:
      - equal:
          documentIndex: *deploymentDoc
          path: spec.template.spec.containers[0].lifecycle
          value:
            preStop:
              exec:
                command:
                  - some_command

  - it: should pass with single preStop lifecycle set from tpl
    set:
      some_key: some_command
      lifecycle:
        preStop:
          command: "{{ .Values.some_key }}"
    asserts:
      - equal:
          documentIndex: *deploymentDoc
          path: spec.template.spec.containers[0].lifecycle
          value:
            preStop:
              exec:
                command:
                  - some_command


  - it: should pass with preStop lifecycle set
    set:
      lifecycle:
        preStop:
          command:
            - /bin/bash
            - test
    asserts:
      - equal:
          documentIndex: *deploymentDoc
          path: spec.template.spec.containers[0].lifecycle
          value:
            preStop:
              exec:
                command:
                  - /bin/bash
                  - test

  - it: should pass with preStop lifecycle set from tpl
    set:
      some_key: some_value
      lifecycle:
        preStop:
          command:
            - /bin/bash
            - "{{ .Values.some_key }}"
    asserts:
      - equal:
          documentIndex: *deploymentDoc
          path: spec.template.spec.containers[0].lifecycle
          value:
            preStop:
              exec:
                command:
                  - /bin/bash
                  - some_value

  - it: should pass with terminationMessagePath set
    set:
      termination:
        messagePath: /tmp/log
    asserts:
      - equal:
          documentIndex: *deploymentDoc
          path: spec.template.spec.containers[0].terminationMessagePath
          value: /tmp/log

  - it: should pass with terminationMessagePath set from tpl
    set:
      some_path: /tmp/log
      termination:
        messagePath: "{{ .Values.some_path }}"
    asserts:
      - equal:
          documentIndex: *deploymentDoc
          path: spec.template.spec.containers[0].terminationMessagePath
          value: /tmp/log

  - it: should pass with terminationMessagePolicy set
    set:
      termination:
        messagePolicy: FallbackToLogsOnError
    asserts:
      - equal:
          documentIndex: *deploymentDoc
          path: spec.template.spec.containers[0].terminationMessagePolicy
          value: FallbackToLogsOnError

  - it: should pass with terminationMessagePolicy set from tpl
    set:
      some_key: FallbackToLogsOnError
      termination:
        messagePolicy: "{{ .Values.some_key }}"
    asserts:
      - equal:
          documentIndex: *deploymentDoc
          path: spec.template.spec.containers[0].terminationMessagePolicy
          value: FallbackToLogsOnError

  - it: should fail with invalid terminationMessagePolicy
    set:
      some_key: invalid
      termination:
        messagePolicy: "{{ .Values.some_key }}"
    asserts:
      - failedTemplate:
          documentIndex: *deploymentDoc
          errorMessage: Not valid option for messagePolicy

  - it: should fail with no command in preStop
    set:
      lifecycle:
        preStop:
          command: ""
    asserts:
      - failedTemplate:
          documentIndex: *deploymentDoc
          errorMessage: No commands were given for preStop lifecycle hook

  - it: should fail with no command in postStart
    set:
      lifecycle:
        postStart:
          command: ""
    asserts:
      - failedTemplate:
          documentIndex: *deploymentDoc
          errorMessage: No commands were given for postStart lifecycle hook
