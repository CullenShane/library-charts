suite: deployment container port test
templates:
  - common.yaml
tests:
  - it: should pass with default values
    asserts:
      - hasDocuments:
          count: 1
      - documentIndex: &deploymentDoc 0
        isKind:
          of: Deployment

  - it: should fail with named port
    set:
      service:
        main:
          ports:
            main:
              port: 443
              targetPort: some_name
    asserts:
      - failedTemplate:
          documentIndex: *deploymentDoc
          errorMessage: This common library does not support named ports for targetPort. port name (main), targetPort (some_name)

  - it: should fail without port
    set:
      service:
        main:
          ports:
            main:
              port:
    asserts:
      - failedTemplate:
          documentIndex: *deploymentDoc
          errorMessage: Port is required on enabled services. Service (main)

  - it: should fail with invalid protocol
    set:
      service:
        main:
          ports:
            main:
              port: 443
              protocol: NOT_VALID
    asserts:
      - failedTemplate:
          documentIndex: *deploymentDoc
          errorMessage: Not valid <protocol> (NOT_VALID)

  - it: should pass with with only port set
    set:
      service:
        main:
          ports:
            main:
              port: 443
    asserts:
      - equal:
          documentIndex: *deploymentDoc
          path: spec.template.spec.containers[0].ports[0]
          value:
            name: main
            containerPort: 443
            protocol: TCP

  - it: should pass with with port and targetPort set
    set:
      service:
        main:
          ports:
            main:
              port: 443
              targetPort: 8000
    asserts:
      - equal:
          documentIndex: *deploymentDoc
          path: spec.template.spec.containers[0].ports[0]
          value:
            name: main
            containerPort: 8000
            protocol: TCP

  - it: should pass with with port and targetPort and protocol set
    set:
      service:
        main:
          ports:
            main:
              port: 443
              protocol: TCP
              targetPort: 8000
    asserts:
      - equal:
          documentIndex: *deploymentDoc
          path: spec.template.spec.containers[0].ports[0]
          value:
            name: main
            containerPort: 8000
            protocol: TCP

  - it: should pass with with port and targetPort and protocol UDP set
    set:
      service:
        main:
          ports:
            main:
              port: 443
              protocol: UDP
              targetPort: 8000
    asserts:
      - equal:
          documentIndex: *deploymentDoc
          path: spec.template.spec.containers[0].ports[0]
          value:
            name: main
            containerPort: 8000
            protocol: UDP

  - it: should pass with with port and targetPort and protocol HTTP set
    set:
      service:
        main:
          ports:
            main:
              port: 443
              protocol: HTTP
              targetPort: 8000
    asserts:
      - equal:
          documentIndex: *deploymentDoc
          path: spec.template.spec.containers[0].ports[0]
          value:
            name: main
            containerPort: 8000
            protocol: TCP

  - it: should pass with with port and targetPort and protocol HTTPS set
    set:
      service:
        main:
          ports:
            main:
              port: 443
              protocol: HTTPS
              targetPort: 8000
    asserts:
      - equal:
          documentIndex: *deploymentDoc
          path: spec.template.spec.containers[0].ports[0]
          value:
            name: main
            containerPort: 8000
            protocol: TCP

  - it: should pass with with multiple port and targetPort and protocol set
    set:
      service:
        main:
          ports:
            main:
              port: 443
              protocol: HTTP
              targetPort: 8000
        secondary:
          enabled: true
          ports:
            secondary:
              enabled: true
              port: 444
              protocol: TCP
              targetPort: 8001
        third:
          enabled: true
          ports:
            third:
              enabled: true
              port: 445
              protocol: UDP
              targetPort: 8002
    asserts:
      - equal:
          documentIndex: *deploymentDoc
          path: spec.template.spec.containers[0].ports
          value:
            - name: main
              containerPort: 8000
              protocol: TCP
            - name: secondary
              containerPort: 8001
              protocol: TCP
            - name: third
              containerPort: 8002
              protocol: UDP
