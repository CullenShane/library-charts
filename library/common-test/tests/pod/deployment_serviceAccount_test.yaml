
suite: deployment service account
templates:
  - common.yaml
chart:
  appVersion: v1.2.3
tests:
  - it: should pass with default values
    asserts:
      - isKind:
          of: Deployment

  - it: should pass with service account enabled
    documentIndex: &serviceAccountDoc 0
    set:
      serviceAccount:
        main:
          enabled: true
    asserts:
      - isKind:
          of: ServiceAccount
      - isAPIVersion:
          of: v1
      - equal:
          path: metadata.name
          value: RELEASE-NAME-common-test

  - it: should pass (have correct serviceAccountName) with service account enabled
    documentIndex: &deploymentDoc 1
    set:
      serviceAccount:
        main:
          enabled: true
    asserts:
      - equal:
          path: spec.template.spec.serviceAccountName
          value: RELEASE-NAME-common-test

  - it: should pass with primary service account enabled and nameOverride defined
    documentIndex: *serviceAccountDoc
    set:
      serviceAccount:
        main:
          enabled: true
          nameOverride: some-name
    asserts:
      - equal:
          path: metadata.name
          value: RELEASE-NAME-common-test-some-name

  - it: should pass (have correct serviceAccountName) with primary service account enabled and nameOverride defined
    documentIndex: *deploymentDoc
    set:
      serviceAccount:
        main:
          enabled: true
          nameOverride: some-name
    asserts:
      - equal:
          path: spec.template.spec.serviceAccountName
          value: RELEASE-NAME-common-test-some-name

  - it: should pass with primary service account enabled annotations added
    documentIndex: *serviceAccountDoc
    set:
      serviceAccount:
        main:
          enabled: true
          annotations:
            key: value
            key1: value1
    asserts:
      - equal:
          path: metadata.name
          value: RELEASE-NAME-common-test
      - equal:
          path: metadata.annotations
          value:
            key: value
            key1: value1

  - it: should pass with primary service account enabled annotations added from tpl
    documentIndex: *serviceAccountDoc
    set:
      k1: value
      k2: value1
      serviceAccount:
        main:
          enabled: true
          annotations:
            key: "{{ .Values.k1 }}"
            key1: "{{ .Values.k2 }}"
    asserts:
      - equal:
          path: metadata.name
          value: RELEASE-NAME-common-test
      - equal:
          path: metadata.labels
          value:
            app: common-test
            app.kubernetes.io/instance: RELEASE-NAME
            app.kubernetes.io/managed-by: Helm
            app.kubernetes.io/name: common-test
            app.kubernetes.io/version: v1.2.3
            helm-revision: "0"
            helm.sh/chart: common-test-1.0.0
            release: RELEASE-NAME
      - equal:
          path: metadata.annotations
          value:
            key: value
            key1: value1

  - it: should pass with non-primary service account enabled and nameOverride defined
    documentIndex: &serviceAccountDocExtra 1
    set:
      serviceAccount:
        main:
          enabled: true
          primary: true
        other:
          enabled: true
          primary: false
          nameOverride: some-name
    asserts:
      - isKind:
          of: ServiceAccount
      - equal:
          path: metadata.name
          value: RELEASE-NAME-common-test-some-name

  - it: should pass (have correct serviceAccountName) with non-primary service account enabled and nameOverride defined
    documentIndex: &deploymentDoc 2
    set:
      serviceAccount:
        main:
          enabled: true
          primary: true
        other:
          enabled: true
          primary: false
          nameOverride: some-name
    asserts:
      - equal:
          path: spec.template.spec.serviceAccountName
          value: RELEASE-NAME-common-test
