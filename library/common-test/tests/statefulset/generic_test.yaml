suite: statefulset generic test
templates:
  - common.yaml
tests:
  - it: should pass with controller set to StatefulSet
    documentIndex: &statefulsetDoc 0
    set:
      controller.type: StatefulSet
    asserts:
      - hasDocuments:
          count: 3
      - isKind:
          of: StatefulSet
      - isAPIVersion:
          of: apps/v1


  - it: should pass with podSecurityContext changed
    documentIndex: *statefulsetDoc
    set:
      controller.type: StatefulSet
      podSecurityContext:
        fsGroup: 0
        fsGroupChangePolicy: Always
        supplementalGroups:
          - 1000
    asserts:
      - equal:
          path: spec.template.spec.securityContext
          value:
            fsGroup: 0
            fsGroupChangePolicy: Always
            supplementalGroups:
              - 1000


  - it: should pass with podSecurityContext changed
    documentIndex: *statefulsetDoc
    set:
      controller.type: StatefulSet
      securityContext:
        runAsUser: 1000
        runAsGroup: 1000
        capabilities:
          add:
            - something
    asserts:
      - equal:
          path: spec.template.spec.containers[0].securityContext
          value:
            allowPrivilegeEscalation: false
            privileged: false
            readOnlyRootFilesystem: true
            runAsNonRoot: true
            runAsUser: 1000
            runAsGroup: 1000
            capabilities:
              add:
                - something
              drop:
                - ALL
